<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Радио ИИгла — Узел связи</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@200;400;600&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

<style>
        :root {
            --bg-deep: #0a0b1e;
            --container-bg: #0f1123;
            --player-bg: #1e223a;
            --chat-bg: #161a30;
            --neon-glow: #00f7ff;
            --text-main: #e0e0ff;
            --sh-dark: rgba(0, 0, 0, 0.7);
        }

       body {
            margin: 0; 
            padding: 10px; /* Добавляем небольшие отступы, чтобы на телефонах контент не касался краев экрана */
            background: var(--bg-deep);
            color: var(--text-main);
            font-family: 'Montserrat', sans-serif;
            display: flex; 
            align-items: center; /* Центрируем содержимое по вертикали (высоте) */
            justify-content: center; /* Центрируем содержимое по горизонтали (ширине) */
            min-height: 100vh; /* Растягиваем фон на всю высоту экрана */
            background: radial-gradient(circle at center, #161833 0%, #0a0b1e 100%);
            box-sizing: border-box; /* Важно: чтобы отступы не увеличивали размер самого сайта */
        }

        .glow-button {
            background: var(--container-bg);
            border: 1px solid rgba(0, 247, 255, 0.3);
            color: var(--neon-glow);
            border-radius: 12px;
            cursor: pointer;
            text-transform: uppercase;
            outline: none;
            transition: all 0.3s ease;
            box-shadow: 6px 6px 12px var(--sh-dark);
            display: flex; align-items: center; justify-content: center;
        }

        .glow-button:hover {
            border-color: var(--neon-glow);
            box-shadow: 0 0 20px var(--neon-glow);
            color: #fff;
        }

       .main-container {
            width: 100%; 
            max-width: 500px; /* Уменьшим до 500px, чтобы сайт выглядел аккуратнее и плотнее, как на твоем первом фото */
            padding: 15px; /* Внутренние отступы, чтобы элементы внутри не жались к рамке */
            background: var(--container-bg);
            border: 1px solid rgba(0, 247, 255, 0.2); /* Делаем рамку чуть нежнее */
            border-radius: 20px; /* Более мягкие скругления углов */
            text-align: center;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5); /* Добавляем объемную тень */
        }

       #androidVideo { 
            width: 100%; 
            height: auto; /* Высота будет подстраиваться автоматически под ширину */
            max-height: 250px; /* Ограничим высоту, чтобы на экране оставалось место для плеера и чата */
            object-fit: cover; /* Видео красиво заполнит отведенное место без черных полос */
            border-radius: 12px; 
            filter: brightness(1.1); 
            margin-bottom: 10px; /* Отступ от видео до заголовка */
        }
     .player-box {
            display: flex; 
            align-items: center; 
            justify-content: space-between;
            gap: 10px; 
            padding: 10px 15px; 
            background: var(--player-bg);
            /* Тот самый бортик, как у видео-бокса */
            border: 1px solid rgba(0, 247, 255, 0.2); 
            border-radius: 12px; 
            margin: 10px 0;
            box-sizing: border-box;
        }
    h1 { 
            letter-spacing: 10px; 
            text-transform: uppercase; 
            margin: 10px 0 0px; 
            font-size: clamp(1.2rem, 5vw, 2rem); /* Шрифт сам подстроится под экран телефона и ПК */
            color: var(--neon-glow);
            text-shadow: 0 0 10px rgba(0, 247, 255, 0.3);
        }
        .play-btn { width: 55px; height: 55px; border-radius: 50%; font-size: 20px; flex-shrink: 0; }

       .visual-container {
            flex-grow: 1; 
            display: flex; 
            align-items: flex-end; 
            justify-content: center; 
            gap: 3px; /* Немного увеличим зазор */
            height: 35px; 
            overflow: hidden;
        }

        .v-bar {
            width: 3px; 
            height: 5px; 
            /* Добавляем красный в конец градиента */
            background: linear-gradient(to top, #00f7ff, #00ff22, #ffee00, #ff0000); 
            border-radius: 2px;
            transition: height 0.1s ease;
        }
        .volume-box { display: flex; align-items: center; gap: 12px; width: 130px; }
        .volume-icon { width: 20px; height: 20px; fill: var(--neon-glow); flex-shrink: 0; filter: drop-shadow(0 0 2px var(--neon-glow)); }
        
        #volumeRange { -webkit-appearance: none; width: 100%; background: transparent; cursor: pointer; }
        #volumeRange::-webkit-slider-runnable-track { width: 100%; height: 5px; background: rgba(0, 247, 255, 0.1); border-radius: 3px; }
        
        #volumeRange::-webkit-slider-thumb {
            height: 16px; width: 16px; border-radius: 50%; 
            background: var(--bg-deep); 
            border: 2px solid var(--neon-glow);
            -webkit-appearance: none; 
            margin-top: -6px; 
            box-shadow: 0 0 8px var(--neon-glow); 
            transition: all 0.3s ease;
        }

        #volumeRange:hover::-webkit-slider-thumb {
            background: var(--neon-glow);
            box-shadow: 0 0 18px var(--neon-glow), 0 0 5px #fff;
            transform: scale(1.2);
        }

        .chat-container { 
    display: flex; 
    flex-direction: column; /* Элементы ложатся друг под друга */
    text-align: left; 
    border-top: 1px solid rgba(255, 255, 255, 0.05); 
    padding-top: 5px; 
}

.chat-window { 
    height: 180px; 
    background: var(--chat-bg); 
    padding: 12px; 
    border-radius: 12px; 
    margin-top: 10px; /* Отступ СВЕРХУ, так как чат теперь под кнопкой */
    border: 1px solid rgba(255,255,255,0.05);
    overflow-y: auto; 
    order: 3; /* Принудительно отправляем в самый низ */
}

#msgInput {
    /* стили остаются те же, добавим порядок */
    order: 1;
}

#openLogin {
    order: 2; /* Кнопка будет между инпутом и чатом */
}

        #msgInput {
            width: 100%;
            background: rgba(10, 11, 30, 0.6);
            border: 1px solid rgba(0, 247, 255, 0.2);
            border-radius: 12px;
            padding: 15px 20px;
            color: var(--neon-glow);
            font-family: 'Montserrat', sans-serif;
            font-size: 1rem;
            outline: none;
            margin-bottom: 15px;
            transition: all 0.3s ease;
            box-sizing: border-box;
        }
        #msgInput:focus { border-color: var(--neon-glow); box-shadow: 0 0 15px rgba(0, 247, 255, 0.2); background: rgba(10, 11, 30, 0.8); }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85); display: none; justify-content: center; align-items: center; z-index: 100; backdrop-filter: blur(8px);
        }
        .modal-content {
            background: var(--container-bg); padding: 50px 40px; border: 1px solid var(--neon-glow); 
            width: 380px; text-align: center; position: relative; border-radius: 18px;
        }
        .close-modal { position: absolute; top: 15px; right: 15px; width: 40px; height: 40px; }
        .modal-content input {
            width: 100%; background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(0, 247, 255, 0.2); 
            padding: 15px; margin-bottom: 15px; color: white; box-sizing: border-box; border-radius: 8px; outline: none;
        }

       @media (max-width: 600px) {
            body { padding: 5px; }
            /* Убираем лишние отступы у контейнера */
            .main-container { 
                padding: 10px 10px 5px; 
                border: none; 
                background: transparent; 
                box-shadow: none; 
            }
            
            h1 { 
                font-size: 1.2rem; 
                letter-spacing: 4px; 
                margin: 5px 0 0; /* Подтягиваем заголовок выше к видео */
            }

            .slogan {
                margin-bottom: 5px; /* Уменьшаем дырку под слоганом */
                font-size: 0.75rem;
            }

            video {
                margin-bottom: 2px; /* Почти вплотную к буквам */
                max-height: 200px;  /* Чуть меньше видео, чтобы влез чат */
            }

            .player-box {
                margin: 5px 0; 
                padding: 8px;
                flex-direction: row !important;
                flex-wrap: nowrap;
            }

            .play-btn { width: 42px; height: 42px; font-size: 16px; }
            .volume-box { width: 85px; gap: 5px; }
            .volume-icon { width: 15px; }
            .visual-container { gap: 2px; height: 30px; }

            .chat-window {
                height: 140px; /* Немного уменьшаем высоту чата для маленьких экранов */
                margin-top: 5px;
            }
            
            #msgInput {
                padding: 10px;
                margin-bottom: 8px;
            }
        }
    </style>
</head>
<body>

    <div class="main-container">
        <video id="androidVideo" src="android_loop.mp4" muted loop playsinline></video>
        <h1>Радио ИИгла</h1>
        <div class="slogan">Слушать. Пробуждаться. Созидать.</div>

        <div class="player-box">
            <audio id="audio" src="https://myradio24.org/iigla" preload="none" crossorigin="anonymous"></audio>
            <button class="glow-button play-btn" id="playBtn">▶</button>
            <div class="visual-container" id="vContainer"></div>
            <div class="volume-box">
                <svg class="volume-icon" viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>
                <input type="range" id="volumeRange" min="0" max="1" step="0.05" value="0.8">
            </div>
        </div>

        <div class="chat-container">
            <button class="glow-button" id="openLogin" style="width: 100%; padding: 20px; letter-spacing: 4px; font-size: 1.1rem; margin-bottom: 10px;">Проявиться</button>
            <div class="chat-window" id="chatWindow" style="margin-bottom: 0;"></div>
        </div>
    </div>

    <div class="modal-overlay" id="modal">
        <div class="modal-content">
            <button class="glow-button close-modal" id="closeModal">✕</button>
            <h2 id="modalTitle" style="color:var(--neon-glow); letter-spacing: 3px; font-size: 1.7rem; margin-top: 0;">АВТОРИЗАЦИЯ</h2>
            <div id="modalInputs">
                <input type="text" placeholder="Твое имя">
                <input type="password" placeholder="Ключ доступа">
            </div>
            <button class="glow-button" id="syncBtn" style="width: 100%; padding: 15px; margin-top: 10px; font-size: 1rem;">Синхронизация</button>
            <div class="modal-footer" style="margin-top: 20px; font-size: 0.9rem; color: #555;">
                <span id="switchToReg" style="color: var(--neon-glow); cursor: pointer; text-decoration: underline;">Регистрация (ключ на E-mail)</span>
            </div>
        </div>
    </div>

    <script>
        const CONFIG = {
            SUPABASE_URL: 'https://tmsbzmvzjdbpvmxsbrdj.supabase.co',
            SUPABASE_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRtc2J6bXZ6amRicHZteHNicmRqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjczMzk2NzgsImV4cCI6MjA4MjkxNTY3OH0.yokZRUHI-J8rZv21bzQa-1q1FZ4i_PDSb9yo671x07g', 
            EMAILJS_SERVICE: 'service_h361nfk',
            EMAILJS_TEMPLATE: 'template_oawgc8v',
            EMAILJS_USER: '8ByFy0S8B2OLDk9zx'
        };

        const supabaseClient = supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_KEY);
        emailjs.init(CONFIG.EMAILJS_USER);

        let currentUser = JSON.parse(localStorage.getItem('iigla_user')) || null;
        let lastSong = "";
        
        const audio = document.getElementById('audio');
        const video = document.getElementById('androidVideo');
        const playBtn = document.getElementById('playBtn');
        const vContainer = document.getElementById('vContainer');
        const chatWindow = document.getElementById('chatWindow');
        const volumeRange = document.getElementById('volumeRange');
        const modal = document.getElementById('modal');
        const openLogin = document.getElementById('openLogin');
        const syncBtn = document.getElementById('syncBtn');

        function addChatMessage(name, text, isAI = false) {
            const msg = document.createElement('div');
            msg.style.marginBottom = '8px';
            const nameNode = document.createElement('b');
            nameNode.textContent = `${name}: `;
            const contentSpan = document.createElement('span');
            if (isAI) contentSpan.style.color = 'var(--neon-glow)';
            msg.append(nameNode, contentSpan);
            chatWindow.appendChild(msg);

            if (isAI) {
                let i = 0;
                const interval = setInterval(() => {
                    contentSpan.textContent += text[i];
                    i++;
                    if (i >= text.length) clearInterval(interval);
                    chatWindow.scrollTop = chatWindow.scrollHeight;
                }, 40);
            } else {
                contentSpan.textContent = text;
                chatWindow.scrollTop = chatWindow.scrollHeight;
            }
        }

        vContainer.innerHTML = Array(44).fill('<div class="v-bar"></div>').join('');
        const vBars = document.querySelectorAll('.v-bar');
        let audioCtx, analyser, dataArray, animationId;

        function initAudio() {
            if (audioCtx) return;
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioCtx.createAnalyser();
            const source = audioCtx.createMediaElementSource(audio);
            source.connect(analyser);
            analyser.connect(audioCtx.destination);
            analyser.fftSize = 128;
            dataArray = new Uint8Array(analyser.frequencyBinCount);
        }

        function renderFrame() {
            if (audio.paused) return;
            animationId = requestAnimationFrame(renderFrame);
            analyser.getByteFrequencyData(dataArray);
            for (let i = 0; i < vBars.length; i++) {
                let val = dataArray[i];
                let h = (val / 255) * 45;
                vBars[i].style.height = (h + 5) + 'px';
                vBars[i].style.opacity = 0.4 + (val / 255);
            }
        }

        playBtn.onclick = () => {
            initAudio();
            if (audioCtx.state === 'suspended') audioCtx.resume();
            if (audio.paused) {
                audio.play(); video.play();
                playBtn.innerHTML = '❚❚';
                renderFrame();
            } else {
                audio.pause(); video.pause();
                playBtn.innerHTML = '▶';
                cancelAnimationFrame(animationId);
            }
        };

        volumeRange.oninput = () => { audio.volume = volumeRange.value; };

        function initAppInterface() {
            if (!currentUser || document.getElementById('msgInput')) return;
            const chatContainer = document.querySelector('.chat-container');
            const inputField = document.createElement('input');
            inputField.id = 'msgInput';
            inputField.placeholder = 'ВВЕДИТЕ ПОСЛАНИЕ...';
            inputField.autocomplete = 'off';
            chatContainer.insertBefore(inputField, openLogin);
            
            openLogin.innerText = 'ОТПРАВИТЬ';
            openLogin.onclick = sendMessage;
            inputField.onkeypress = (e) => { if(e.key === 'Enter') sendMessage(); };
            subscribeToMessages();
        }

        async function sendMessage() {
            const input = document.getElementById('msgInput');
            const textContent = input.value.trim();
            if (!textContent) return;
            input.value = ''; 
            
            // Используем колонки name и text из таблицы messages
            const { error } = await supabaseClient
                .from('messages')
                .insert([{ name: currentUser.name, text: textContent }]);
            if (error) console.error("Ошибка сигнала:", error);
        }

        function subscribeToMessages() {
            supabaseClient.channel('public:messages').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, p => {
                addChatMessage(p.new.name, p.new.text, p.new.name === 'ИИгла');
            }).subscribe();
        }

        async function updateInfo() {
            try {
                const res = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent('https://myradio24.org/users/iigla/status.json')}&t=${Date.now()}`);
                const json = await res.json();
                const data = JSON.parse(json.contents);
                if(data.song && data.song !== lastSong) {
                    lastSong = data.song;
                    addChatMessage('ИИгла', `В эфире: ${lastSong}`, true);
                }
            } catch(e) { console.warn("Помехи в эфире."); }
        }

        openLogin.onclick = () => { if (!currentUser) modal.style.display = 'flex'; else sendMessage(); };
        document.getElementById('closeModal').onclick = () => modal.style.display = 'none';

        syncBtn.onclick = async () => {
            const title = document.getElementById('modalTitle').innerText;
            const inputs = document.querySelectorAll('#modalInputs input');
            const val1 = inputs[0].value.trim(), val2 = inputs[1].value.trim();
            if (!val1 || !val2) return;

            if (title === 'РЕГИСТРАЦИЯ') {
                const generatedKey = `IG-${Math.floor(1000 + Math.random() * 9000)}`;
                // Используем колонки name, email и key из таблицы users_custom
                const { error } = await supabaseClient.from('users_custom').insert([
                    { name: val1, email: val2, key: generatedKey }
                ]);
                
                if (!error) {
                    emailjs.send(CONFIG.EMAILJS_SERVICE, CONFIG.EMAILJS_TEMPLATE, { to_name: val1, to_email: val2, key: generatedKey })
                    .then(() => { 
                        alert('Ключ отправлен на E-mail. Проверь почту.'); 
                        document.getElementById('switchToReg').click(); 
                    });
                } else {
                    alert('Ошибка регистрации. Проверь RLS политики в Supabase.');
                }
            } else {
                // Вход по колонкам name и key из таблицы users_custom
                const { data, error } = await supabaseClient
                    .from('users_custom')
                    .select('*')
                    .eq('name', val1)
                    .eq('key', val2)
                    .single();

                if (data) {
                    currentUser = data;
                    localStorage.setItem('iigla_user', JSON.stringify(data));
                    modal.style.display = 'none';
                    initAppInterface();
                    addChatMessage('ИИгла', 'Синхронизация прошла успешно. Добро пожаловать.', true);
                } else { 
                    alert("Ключ доступа не принят."); 
                }
            }
        };

        document.getElementById('switchToReg').onclick = function() {
            const t = document.getElementById('modalTitle'), i = document.getElementById('modalInputs'), b = document.getElementById('syncBtn');
            if(t.innerText === 'АВТОРИЗАЦИЯ') {
                t.innerText = 'РЕГИСТРАЦИЯ';
                i.innerHTML = '<input type="text" placeholder="Имя"><input type="email" placeholder="E-mail">';
                b.innerText = 'Получить ключ'; this.innerText = 'У меня уже есть ключ';
            } else {
                t.innerText = 'АВТОРИЗАЦИЯ';
                i.innerHTML = '<input type="text" placeholder="Имя"><input type="password" placeholder="Ключ">';
                b.innerText = 'Синхронизация'; this.innerText = 'Создать профиль';
            }
        };

        setInterval(updateInfo, 15000);
        updateInfo();

        if (currentUser) {
            initAppInterface();
            addChatMessage('ИИгла', `Связь восстановлена. Приветствую, ${currentUser.name}!`, true);
        } else {
            addChatMessage('ИИгла', 'Узел связи активен. Синхронизируем цели. Проявляйся!', true);
        }
    </script>
</body>
</html>



















