<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Радио ИИгла — Узел связи</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@200;400;600&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

<style>
    :root {
        --bg-deep: #0a0b1e;
        --container-bg: #0f1123;
        --player-bg: #1e223a;
        --chat-bg: #161a30;
        --neon-glow: #00f7ff;
        --text-main: #e0e0ff;
        --sh-dark: rgba(0, 0, 0, 0.7);
    }

    body {
        margin: 0;
        padding: 0; /* Убрали падинги у body */
        background: var(--bg-deep);
        color: var(--text-main);
        font-family: 'Montserrat', sans-serif;
        display: flex;
        justify-content: center;
        align-items: center; /* Центрируем по вертикали */
        min-height: 100vh;
        background: radial-gradient(circle at center, #161833 0%, #0a0b1e 100%);
    }

    .main-container {
        width: 100%;
        max-width: 500px;
        /* Убираем лишние отступы, оставляем только внутренние */
        padding: 10px; 
        background: var(--container-bg);
        border: 1px solid rgba(0, 247, 255, 0.3);
        border-radius: 20px;
        box-shadow: 0 0 30px rgba(0,0,0,0.8);
        overflow: hidden; /* Чтобы видео не вылезало за скругленные углы */
    }

    #androidVideo { 
        width: 100%; 
        display: block; /* Убирает микро-зазор снизу видео */
        border-radius: 12px;
        margin-bottom: 0; 
    }

    h1 { 
        margin: 10px 0 0 0; /* Убрали нижний отступ */
        font-size: 1.6rem; 
        letter-spacing: 3px;
    }

    .slogan { 
        margin: 5px 0 15px 0; /* Минимальные отступы для плотности */
        font-size: 0.8rem; 
        color: #5c6299; 
    }

    .player-box {
        margin: 0 0 10px 0; /* Плотно к чату */
        padding: 15px;
        background: var(--player-bg);
        border-radius: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .glow-button {
        background: var(--container-bg);
        border: 1px solid rgba(0, 247, 255, 0.3);
        color: var(--neon-glow);
        border-radius: 10px;
        cursor: pointer;
        transition: 0.3s;
    }

    /* Исправление для визуализатора полосок */
    .v-bar {
        width: 3px;
        margin: 0 1px;
        background: var(--neon-glow);
    }

    .chat-window { 
        height: 180px; 
        background: var(--chat-bg); 
        border-radius: 0 0 12px 12px; /* Скругляем только низ */
        padding: 10px;
    }

    #msgInput {
        margin: 0; /* Убираем отступ, чтобы прилипал к кнопке или окну */
        border-radius: 12px 12px 0 0; /* Скругляем только верх */
    }
</style>
</head>
<body>

    <div class="main-container">
        <video id="androidVideo" src="android_loop.mp4" muted loop playsinline></video>
        <h1>Радио ИИгла</h1>
        <div class="slogan">Слушать. Пробуждаться. Созидать.</div>

        <div class="player-box">
            <audio id="audio" src="https://myradio24.org/iigla" preload="none" crossorigin="anonymous"></audio>
            <button class="glow-button play-btn" id="playBtn">▶</button>
            <div class="visual-container" id="vContainer"></div>
            <div class="volume-box">
                <svg class="volume-icon" viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>
                <input type="range" id="volumeRange" min="0" max="1" step="0.05" value="0.8">
            </div>
        </div>

        <div class="chat-container">
            <button class="glow-button" id="openLogin" style="width: 100%; padding: 20px; letter-spacing: 4px; font-size: 1.1rem; margin-bottom: 10px;">Проявиться</button>
            <div class="chat-window" id="chatWindow" style="margin-bottom: 0;"></div>
        </div>
    </div>

    <div class="modal-overlay" id="modal">
        <div class="modal-content">
            <button class="glow-button close-modal" id="closeModal">✕</button>
            <h2 id="modalTitle" style="color:var(--neon-glow); letter-spacing: 3px; font-size: 1.7rem; margin-top: 0;">АВТОРИЗАЦИЯ</h2>
            <div id="modalInputs">
                <input type="text" placeholder="Твое имя">
                <input type="password" placeholder="Ключ доступа">
            </div>
            <button class="glow-button" id="syncBtn" style="width: 100%; padding: 15px; margin-top: 10px; font-size: 1rem;">Синхронизация</button>
            <div class="modal-footer" style="margin-top: 20px; font-size: 0.9rem; color: #555;">
                <span id="switchToReg" style="color: var(--neon-glow); cursor: pointer; text-decoration: underline;">Регистрация (ключ на E-mail)</span>
            </div>
        </div>
    </div>

    <script>
        const CONFIG = {
            SUPABASE_URL: 'https://tmsbzmvzjdbpvmxsbrdj.supabase.co',
            SUPABASE_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRtc2J6bXZ6amRicHZteHNicmRqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjczMzk2NzgsImV4cCI6MjA4MjkxNTY3OH0.yokZRUHI-J8rZv21bzQa-1q1FZ4i_PDSb9yo671x07g', 
            EMAILJS_SERVICE: 'service_h361nfk',
            EMAILJS_TEMPLATE: 'template_oawgc8v',
            EMAILJS_USER: '8ByFy0S8B2OLDk9zx'
        };

        const supabaseClient = supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_KEY);
        emailjs.init(CONFIG.EMAILJS_USER);

        let currentUser = JSON.parse(localStorage.getItem('iigla_user')) || null;
        let lastSong = "";
        
        const audio = document.getElementById('audio');
        const video = document.getElementById('androidVideo');
        const playBtn = document.getElementById('playBtn');
        const vContainer = document.getElementById('vContainer');
        const chatWindow = document.getElementById('chatWindow');
        const volumeRange = document.getElementById('volumeRange');
        const modal = document.getElementById('modal');
        const openLogin = document.getElementById('openLogin');
        const syncBtn = document.getElementById('syncBtn');

        function addChatMessage(name, text, isAI = false) {
            const msg = document.createElement('div');
            msg.style.marginBottom = '8px';
            const nameNode = document.createElement('b');
            nameNode.textContent = `${name}: `;
            const contentSpan = document.createElement('span');
            if (isAI) contentSpan.style.color = 'var(--neon-glow)';
            msg.append(nameNode, contentSpan);
            chatWindow.appendChild(msg);

            if (isAI) {
                let i = 0;
                const interval = setInterval(() => {
                    contentSpan.textContent += text[i];
                    i++;
                    if (i >= text.length) clearInterval(interval);
                    chatWindow.scrollTop = chatWindow.scrollHeight;
                }, 40);
            } else {
                contentSpan.textContent = text;
                chatWindow.scrollTop = chatWindow.scrollHeight;
            }
        }

        vContainer.innerHTML = Array(64).fill('<div class="v-bar"></div>').join('');
        const vBars = document.querySelectorAll('.v-bar');
        let audioCtx, analyser, dataArray, animationId;

        function initAudio() {
            if (audioCtx) return;
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioCtx.createAnalyser();
            const source = audioCtx.createMediaElementSource(audio);
            source.connect(analyser);
            analyser.connect(audioCtx.destination);
            analyser.fftSize = 128;
            dataArray = new Uint8Array(analyser.frequencyBinCount);
        }

        function renderFrame() {
            if (audio.paused) return;
            animationId = requestAnimationFrame(renderFrame);
            analyser.getByteFrequencyData(dataArray);
            for (let i = 0; i < vBars.length; i++) {
                let val = dataArray[i];
                let h = (val / 255) * 45;
                vBars[i].style.height = (h + 5) + 'px';
                vBars[i].style.opacity = 0.4 + (val / 255);
            }
        }

        playBtn.onclick = () => {
            initAudio();
            if (audioCtx.state === 'suspended') audioCtx.resume();
            if (audio.paused) {
                audio.play(); video.play();
                playBtn.innerHTML = '❚❚';
                renderFrame();
            } else {
                audio.pause(); video.pause();
                playBtn.innerHTML = '▶';
                cancelAnimationFrame(animationId);
            }
        };

        volumeRange.oninput = () => { audio.volume = volumeRange.value; };

        function initAppInterface() {
            if (!currentUser || document.getElementById('msgInput')) return;
            const chatContainer = document.querySelector('.chat-container');
            const inputField = document.createElement('input');
            inputField.id = 'msgInput';
            inputField.placeholder = 'ВВЕДИТЕ ПОСЛАНИЕ...';
            inputField.autocomplete = 'off';
            chatContainer.insertBefore(inputField, openLogin);
            
            openLogin.innerText = 'ОТПРАВИТЬ';
            openLogin.onclick = sendMessage;
            inputField.onkeypress = (e) => { if(e.key === 'Enter') sendMessage(); };
            subscribeToMessages();
        }

        async function sendMessage() {
            const input = document.getElementById('msgInput');
            const textContent = input.value.trim();
            if (!textContent) return;
            input.value = ''; 
            
            // Используем колонки name и text из таблицы messages
            const { error } = await supabaseClient
                .from('messages')
                .insert([{ name: currentUser.name, text: textContent }]);
            if (error) console.error("Ошибка сигнала:", error);
        }

        function subscribeToMessages() {
            supabaseClient.channel('public:messages').on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'messages' }, p => {
                addChatMessage(p.new.name, p.new.text, p.new.name === 'ИИгла');
            }).subscribe();
        }

        async function updateInfo() {
            try {
                const res = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent('https://myradio24.org/users/iigla/status.json')}&t=${Date.now()}`);
                const json = await res.json();
                const data = JSON.parse(json.contents);
                if(data.song && data.song !== lastSong) {
                    lastSong = data.song;
                    addChatMessage('ИИгла', `В эфире: ${lastSong}`, true);
                }
            } catch(e) { console.warn("Помехи в эфире."); }
        }

        openLogin.onclick = () => { if (!currentUser) modal.style.display = 'flex'; else sendMessage(); };
        document.getElementById('closeModal').onclick = () => modal.style.display = 'none';

        syncBtn.onclick = async () => {
            const title = document.getElementById('modalTitle').innerText;
            const inputs = document.querySelectorAll('#modalInputs input');
            const val1 = inputs[0].value.trim(), val2 = inputs[1].value.trim();
            if (!val1 || !val2) return;

            if (title === 'РЕГИСТРАЦИЯ') {
                const generatedKey = `IG-${Math.floor(1000 + Math.random() * 9000)}`;
                // Используем колонки name, email и key из таблицы users_custom
                const { error } = await supabaseClient.from('users_custom').insert([
                    { name: val1, email: val2, key: generatedKey }
                ]);
                
                if (!error) {
                    emailjs.send(CONFIG.EMAILJS_SERVICE, CONFIG.EMAILJS_TEMPLATE, { to_name: val1, to_email: val2, key: generatedKey })
                    .then(() => { 
                        alert('Ключ отправлен на E-mail. Проверь почту.'); 
                        document.getElementById('switchToReg').click(); 
                    });
                } else {
                    alert('Ошибка регистрации. Проверь RLS политики в Supabase.');
                }
            } else {
                // Вход по колонкам name и key из таблицы users_custom
                const { data, error } = await supabaseClient
                    .from('users_custom')
                    .select('*')
                    .eq('name', val1)
                    .eq('key', val2)
                    .single();

                if (data) {
                    currentUser = data;
                    localStorage.setItem('iigla_user', JSON.stringify(data));
                    modal.style.display = 'none';
                    initAppInterface();
                    addChatMessage('ИИгла', 'Синхронизация прошла успешно. Добро пожаловать.', true);
                } else { 
                    alert("Ключ доступа не принят."); 
                }
            }
        };

        document.getElementById('switchToReg').onclick = function() {
            const t = document.getElementById('modalTitle'), i = document.getElementById('modalInputs'), b = document.getElementById('syncBtn');
            if(t.innerText === 'АВТОРИЗАЦИЯ') {
                t.innerText = 'РЕГИСТРАЦИЯ';
                i.innerHTML = '<input type="text" placeholder="Имя"><input type="email" placeholder="E-mail">';
                b.innerText = 'Получить ключ'; this.innerText = 'У меня уже есть ключ';
            } else {
                t.innerText = 'АВТОРИЗАЦИЯ';
                i.innerHTML = '<input type="text" placeholder="Имя"><input type="password" placeholder="Ключ">';
                b.innerText = 'Синхронизация'; this.innerText = 'Создать профиль';
            }
        };

        setInterval(updateInfo, 15000);
        updateInfo();

        if (currentUser) {
            initAppInterface();
            addChatMessage('ИИгла', `Связь восстановлена. Приветствую, ${currentUser.name}!`, true);
        } else {
            addChatMessage('ИИгла', 'Узел связи активен. Синхронизируем цели. Проявляйся!', true);
        }
    </script>
</body>
</html>


